<tool id="cell_intensity_processing" name="Process single-cell intensities" version="">
    <description>Options to correct for expsure time and autofluorescence. Also option to z-score intensities</description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <command detect_errors="exit_code"><![CDATA[
        
        ln -s '$quant_table' ./quant.csv &&

        ln -s '$channels_csv' ./channels.csv &&

        python '$script'

    ]]></command>
    <configfiles>
        <configfile name = "script">
import os
import numpy as np
import pandas as pd
import scipy.stats as stats

cwd = os.getcwd()
quant = pd.read_csv(os.path.join(cwd, 'quant.csv'))
marker_df = pd.read_csv(os.path.join(cwd, 'channels.csv'))

markers_to_normalize = marker_df['marker_name'].to_list()

#if $exp:

exp_column = str(${exp_col})

for marker in markers_to_normalize:

    exp_time = marker_df.loc[marker_df['marker_name'] == marker, exp_column].values[0]

    quant[marker] = quant[marker] / exp_time

#end if

#if $autofluor:

af_column = str(${AF_col})

for marker in markers_to_normalize:

    current_AF_channel = marker_df.loc[marker_df['marker_name'] == marker, af_column].values[0]

    if current_AF_channel in markers_to_normalize:

        current_AF_mean = np.mean(quant[current_AF_channel])

        quant[marker] = quant[marker] / current_AF_mean

#end if

#if $zscore

for marker in markers_to_normalize:

    quant[marker] = stats.zscore(quant[marker])

#end if

quant.to_csv(os.path.join(cwd, 'processed_quant.csv'))
        </configfile>
    </configfiles>
    <inputs>
        <param name="quant_table" type="data" format="csv" label="Input quantification table (csv)" />
        <param name="channel_csv" type="data" format="csv" label="Channel Metadata (csv)"/>
        <conditional name="exp">
            <param name="correct_exposure" type="boolean" checked="false" label="Correct for exposure time"/>
            <when value="true">
                <param name="exp_col" type="text" value="exposure_time" label="Name of column in markers file containing exposure times" />
            </when>
        </conditional>
        <conditional name="autofluor">
            <param name="signal_ratio" type="boolean" checked="false" label="Calculate signal to noise ratio from autofluorescence channels"/>
            <when value="true">
                <param name="AF_col" type="text" value="AF_channel" label="Name of column in markers file containing respective AF channel for each marker" />
            </when>
        </conditional>
        <param name="zscore" type="boolean" checked="false" label="z-score each marker"/>
    </inputs>
    <outputs>
        <data name="processed_quant" from_work_dir="processed_quant.csv" format="csv"/>
    </outputs>
    <tests>
        <test>
            <param name="quant_table" value="intensities.csv" />
            <param name="channel_csv" value="intensity_channels.csv" />
            <conditional name="exp">
                <param name="correct_exposure" value="true" />
            </conditional>
            <conditional name="autofluor">
                <param name="signal_ratio" value="true" />
            </conditional>
            <param name="zscore" value="true" />
            <output name="processed_quant" ftype="csv">

            </output>
        </test>
    </tests>
    <help><![CDATA[

    ]]></help>
    <expand macro="citations" />
</tool>